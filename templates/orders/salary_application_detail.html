{% extends 'base.html' %}

{% block title %}工资申请详情 - 课程进度管理系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h1 class="mb-4">工资申请详情</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- 申请基本信息 -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-file-invoice-dollar"></i> 申请基本信息
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">申请编号：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="{{ application.id }}">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">申请教师：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="{{ application.teacher.username }}">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">申请日期：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="{{ application.created_at|date:'Y-m-d H:i:s' }}">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">申请金额：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="¥{{ application.apply_amount }}">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">申请状态：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext"
                                       value="
                                       {% if application.status == 'pending' %}待审核{% elif application.status == 'approved' %}已审批{% elif application.status == 'rejected' %}已拒绝{% elif application.status == 'withdrawn' %}已撤回{% endif %}"
                                       style="
                                       {% if application.status == 'pending' %}color: orange;{% elif application.status == 'approved' %}color: green;{% elif application.status == 'rejected' %}color: red;{% elif application.status == 'withdrawn' %}color: gray;{% endif %}"
                                       >
                            </div>
                        </div>
                        {% if application.status == 'approved' %}
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">审批日期：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="{{ application.approved_at|date:'Y-m-d H:i:s' }}">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">审批人：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="{{ application.approved_by.username }}">
                            </div>
                        </div>
                        {% elif application.status == 'rejected' %}
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">拒绝日期：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="{{ application.rejected_at|date:'Y-m-d H:i:s' }}">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">拒绝人：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="{{ application.rejected_by.username }}">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">拒绝原因：</label>
                            <div class="col-sm-8">
                                <textarea readonly class="form-control" rows="2">{{ application.rejection_reason }}</textarea>
                            </div>
                        </div>
                        {% elif application.status == 'withdrawn' %}
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">撤回日期：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="{{ application.withdrawn_at|date:'Y-m-d H:i:s' }}">
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 订单信息 -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <i class="fas fa-shopping-cart"></i> 订单信息
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">订单编号：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="{{ application.order.order_number }}">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">订单名称：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="{{ application.order.name }}">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">订单总金额：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext" value="¥{{ application.order.total_amount }}">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">订单状态：</label>
                            <div class="col-sm-8">
                                <input type="text" readonly class="form-control-plaintext"
                                       value="{% if application.order.status == 'active' %}进行中{% elif application.order.status == 'completed' %}已完成{% endif %}"
                                       style="
                                       {% if application.order.status == 'active' %}color: blue;{% elif application.order.status == 'completed' %}color: green;{% endif %}"
                                       >
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <a href="{% url 'orders:teacher_order_detail' application.order.pk %}" class="btn btn-sm btn-secondary">
                        <i class="fas fa-eye"></i> 查看订单详情
                    </a>
                </div>
            </div>
        </div>
        
        <!-- 备注信息 -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <i class="fas fa-comment"></i> 备注信息
            </div>
            <div class="card-body">
                <textarea readonly class="form-control" rows="3">{{ application.remarks|default:'无备注' }}</textarea>
            </div>
        </div>
        
        <!-- 证明材料 -->
        {% if application.proof_file %} 
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <i class="fas fa-file-alt"></i> 证明材料
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label>上传的证明文件：</label>
                            <div class="mt-2">
                                <a href="{{ application.proof_file.url }}" target="_blank" class="btn btn-primary">
                                    <i class="fas fa-download"></i> 下载证明文件
                                </a>
                                <p class="text-muted mt-2">文件名：{{ application.proof_file.name|slice:'-40:' }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- 操作区域 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-tools"></i> 操作
            </div>
            <div class="card-body">
                {% if user.role == 'admin' and application.status == 'pending' %}
                    <!-- 管理员审核操作 -->
                    <form method="post" action="{% url 'orders:salary_application_approve' application.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success btn-block mb-2">
                            <i class="fas fa-check"></i> 审批通过
                        </button>
                    </form>
                    
                    <button type="button" class="btn btn-danger btn-block mb-2" data-toggle="modal" data-target="#rejectModal">
                        <i class="fas fa-times"></i> 拒绝申请
                    </button>
                {% elif user.role == 'teacher' and application.status == 'pending' %}
                    <!-- 教师撤回操作 -->
                    <form method="post" action="{% url 'orders:salary_application_withdraw' application.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning btn-block mb-2">
                            <i class="fas fa-undo"></i> 撤回申请
                        </button>
                    </form>
                {% elif user.role == 'teacher' and application.status == 'rejected' %}
                    <!-- 教师重新申请操作 -->
                    <a href="{% url 'orders:salary_application_create' %}" class="btn btn-primary btn-block mb-2">
                        <i class="fas fa-redo"></i> 重新申请
                    </a>
                {% endif %}
                
                <!-- 通用返回按钮 -->
                <a href="{% url 'orders:salary_application_list' %}" class="btn btn-secondary btn-block">
                    <i class="fas fa-arrow-left"></i> 返回列表
                </a>
            </div>
        </div>
        
        <!-- 状态说明 -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <i class="fas fa-info-circle"></i> 状态说明
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <span class="badge {% if application.status == 'pending' %}badge-warning{% else %}badge-secondary{% endif %}">待审核</span>
                        <span class="ml-2">管理员正在审核您的申请</span>
                    </li>
                    <li class="mb-2">
                        <span class="badge {% if application.status == 'approved' %}badge-success{% else %}badge-secondary{% endif %}">已审批</span>
                        <span class="ml-2">申请已通过审核，工资将在近期发放</span>
                    </li>
                    <li class="mb-2">
                        <span class="badge {% if application.status == 'rejected' %}badge-danger{% else %}badge-secondary{% endif %}">已拒绝</span>
                        <span class="ml-2">申请未通过审核，请查看拒绝原因</span>
                    </li>
                    <li class="mb-2">
                        <span class="badge {% if application.status == 'withdrawn' %}badge-secondary{% else %}badge-secondary{% endif %}">已撤回</span>
                        <span class="ml-2">您已撤回该申请</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 拒绝申请模态框 -->
<div class="modal fade" id="rejectModal" tabindex="-1" role="dialog" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">拒绝工资申请</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'orders:salary_application_reject' application.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="rejection_reason">拒绝原因：</label>
                        <textarea class="form-control" id="rejection_reason" name="rejection_reason" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-danger">确认拒绝</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 引入Font Awesome图标库 -->

<script>
$(document).ready(function() {
    // 表单提交动画
    $('form').submit(function() {
        $(this).find('button[type="submit"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 处理中...');
    });
});
</script>
{% endblock %}